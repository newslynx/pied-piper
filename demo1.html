<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>Create a zip file demo</title>
<link rel="stylesheet" href="demo.css">
</head>

<body>
	<a href="http://github.com/gildas-lormeau/zip.js"><img style="position: absolute; top: 0; right: 0; border: 0;"
		src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>
	<div id="container">


		<div class="description">
			A JavaScript library to zip and unzip files
			<hr>
		</div>
		
		<h2>Create a zip file demo</h2>
		
		<ol id="demo-container">
			<li>
				<label>
					<span class="form-label">choose temporary storage</span>
					<select id="creation-method-input">
						<option value="Blob">RAM</option>
						<option value="File">HDD</option>
					</select>
				</label>
			</li>
			<li>
				<label>
					<span class="form-label">add files into the zip</span>
					<input type="file" multiple id="file-input">
				</label>
			</li>
			<li>
				<span class="form-label">view zip content</span>
				<ul id="file-list">
				</ul>
			</li>
			<li>
				<label>
					<span class="form-label">set zip file name</span>
					<input type="text" id="filename-input" value="Example.zip">
				</label>
			</li>
			<li>
				<span class="form-label">download the zip file</span>
				<a id="download-button" href="#">Download</a>
			</li>
		</ol>

	</div>
	<script type="text/javascript" src="zip.js"></script>
	<!-- <script type="text/javascript" src="demo1.js"></script> -->
	<script>

		// Cache some functions cross-browserly
		var WINDOW = window,
				URL = WINDOW.webkitURL || WINDOW.mozURL || WINDOW.URL,
				createObjectURL = URL.createObjectURL; // Convert a compressed blob object to a data URL
		// create the blob object storing the data to compress
		// var blob = new Blob([ "Lorem ipsum dolor sit amet, consectetuer adipiscing elit..." ], {
		//   type : "text/plain"
		// });

	  var json_data = [
	  	{name: 'michael'},
	  	{name: 'henry'}
	  ]

		// creates a zip storing the file "lorem.txt" with blob as data
		// the zip will be stored into a Blob object (zippedBlob)
		zipMultiple(json_data, function(zippedBlob) {
			var zipped_blog_href = createObjectURL(zippedBlob);
			var DOM_download_btn = document.getElementById('download-button');
			DOM_download_btn.href = zipped_blog_href;
			DOM_download_btn.download = 'newslynx-data.zip';
		  // unzip the first file from zipped data stored in zippedBlob
		  // unzipBlob(zippedBlob, function(unzippedBlob) {
		  //   // logs the uncompressed Blob
		  //   console.log(unzippedBlob);
		  // });
		});

		function zipMultiple(files, cb) {
			var addIndex = 0,
					writer = new zip.BlobWriter("application/zip"),
					zipWriter;

			function nextFile() {
				var file = files[addIndex],
				 		blob = new Blob([ JSON.stringify(file) ], { type : "text/plain" }),
						blob_reader = new zip.BlobReader(blob);

				zipWriter.add(addIndex.toString()+'-file.txt', blob_reader, function(){
					addIndex++;
					if (addIndex < files.length) {
						nextFile();
					} else {
						zipWriter.close(cb);
					}
				});
			}

			zip.createWriter(writer, function(writer) {
				zipWriter = writer;
				nextFile();
			}, reportError);

			// if (zipWriter)
			// 	nextFile();
			// else if (creationMethod == "Blob") {
			// 	writer = new zip.BlobWriter();
			// 	createZipWriter();
			// } else {
			// 	createTempFile(function(fileEntry) {
			// 		zipFileEntry = fileEntry;
			// 		writer = new zip.FileWriter(zipFileEntry);
			// 		createZipWriter();
			// 	});
			// }
		}

		// function zipMultiple(){
		// 	// Create the zipWriter
		//   zip.createWriter(new zip.BlobWriter("application/zip"), function(writer) {
		//   	zipWriter = writer;
		//   }, reportError);
		// }

		// function createBlog(json){
		// 	json.forEach(function(obj){
		// 		var blob = new Blob([ "Lorem ipsum dolor sit amet, consectetuer adipiscing elit..." ], { type : "text/plain" });
		// 	});
		// }

		function zipObj(json, atIndex, callback){
			var obj = json[atIndex];

	    zipWriter.add(index.toString()+'-file', new zip.BlobReader(blob), function() {
				if (addIndex < files.length){
					nextFile();
				} else {
					onend();
				}
	      // close the writer and calls callback function
	      zipWriter.close(callback);
	    });
			atIndex++;

			zipObj(json, atIndex);
		}

		// function zipJson(json, callback) {
		// 	var atIndex = 0;
		// 		var blob = new Blob([ obj ], { type : "text/plain" });
		//     // use a BlobReader object to read the data stored into blob variable
				
		// 	});
		// }

		function unzipBlob(blob, callback) {
		  // use a zip.BlobReader object to read zipped data stored into blob variable
		  zip.createReader(new zip.BlobReader(blob), function(zipReader) {
		    // get entries from the zip file
		    zipReader.getEntries(function(entries) {
		      // get data from the first file
		      entries[0].getData(new zip.BlobWriter("text/plain"), function(data) {
		        // close the reader and calls callback function with uncompressed data as parameter
		        zipReader.close();
		        callback(data);
		      });
		    });
		  }, reportError);
		}

		function reportError(message) {
		  console.error(message);
		}
	</script>
</body>
</html>